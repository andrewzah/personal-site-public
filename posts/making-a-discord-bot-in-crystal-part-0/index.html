<!doctype html>
<html lang="en-us">
  <head>
      <title>Making a Discord bot in Crystal: Part 0 | Andrew Zah</title>

      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="This walks through building a ping/pong bot in Crystal.">
      <meta name="author" content="Andrew Zah">
      <meta name="keywords" content="tutorial lesson programming crystal discord bot json">

      <meta property="og:title" content="Making a Discord bot in Crystal: Part 0 | Andrew Zah" />
      <meta property="og:author" content="Andrew Zah" />
      <meta property="og:description" content="This walks through building a ping/pong bot in Crystal." />
      <meta property="article:author" content="Andrew Zah" />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="andrewzah.com&#x2f;posts&#x2f;making-a-discord-bot-in-crystal-part-0&#x2f;" />
      <meta property="og:image" content="https://andrewzah.com/og.jpg" />

      <meta name="twitter:card" content="summary">
      <meta name="twitter:site" content="@andrew_zah">
      <meta name="twitter:creator" content="@andrew_zah">
      <meta name="twitter:image" content="https://andrewzah.com/twitter-image.png">

      <meta name="google-site-verification" content="n5-uDhEF_Bwbyie5UOMQK1EdBy4iKsPQIGNJkSVlNU4" />

      <link rel="stylesheet" href="/main.css">

      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=vMdnJYpmNaa">
      <link rel="manifest" href="/site.webmanifest?v=vMdnJYpmNaa">
      <link rel="mask-icon" href="/safari-pinned-tab.svg?v=vMdnJYpmNaa" color="#018a70">
      <link rel="shortcut icon" href="/favicon.ico?v=vMdnJYpmNaa">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="theme-color" content="#ffffff">

      <script async src="/js/bundle.js"></script>
      
  

  </head>

  <script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script>
  <body>
    <div class="container content">
      
        
  <nav>
    <div id="nav-links">
      
      <ul>
        <li><a href="/">Home</a></li>
        <li class="active"><a href="/posts/">Posts</a></li>
        <li ><a href="/projects/">Projects</a></li>
        <li ><a href="/talks/">Talks</a></li>
        <li ><a href="/friends/">Friends</a></li>
        <li ><a href="/contact/">Contact</a></li>
        <li ><a href="/quotes/">Quotes</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
    </div>
  </nav>

      

      <main>
  <div itemtype="http://schema.org/Article" class="container post">
    <h1 class="page-title" itemprop="name">Making a Discord bot in Crystal: Part 0</h1>
    <div class="page-meta-data">
      <time itemprop="datePublished" content="2018-03-05" datetime="2018-03-05" class="page-date">
          Mar 05, 2018
          
      </time>
    </div>
    <hr>
    <aside id="toc">
        <h2>Table of Contents</h2>
        <ol>
            <li>
                <a href="#crystal-and-shards-installation">Crystal and Shards installation</a>
                
            </li><li>
                <a href="#creating-the-project-repo">Creating the project repo</a>
                
            </li><li>
                <a href="#creating-your-bot">Creating your bot</a>
                
            </li><li>
                <a href="#reading-and-writing-json">Reading and Writing JSON</a>
                
            </li><li>
                <a href="#starting-up-discord-client">Starting up Discord::Client</a>
                
            </li><li>
                <a href="#listening-to-input">Listening to input</a>
                
            </li>
        </ol>
    </aside>
    <article itemprop="articleBody">
      <p>Today, let's start with a simple goal: Get a bot up and running via a JSON configuration file, in Crystal, that responds to a &quot;!ping&quot; command.</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<h2 id="crystal-and-shards-installation">Crystal and Shards installation</h2>
<p>In order to install Crystal, you can follow the <a href="https://crystal-lang.org/docs/installation/">docs</a> for your operating system.</p>
<p>You can verify Crystal and Shards are installed by checking their versions:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">λ shards --version
Shards 0.7.2 (2018-01-27)
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">λ crystal -v
Crystal 0.24.1 (2018-01-27)

LLVM: 5.0.1
Default target: x86_64-apple-macosx
</span></pre><h2 id="creating-the-project-repo">Creating the project repo</h2>
<p>Crystal provides an <code>init TYPE NAME [DIR]</code> command for us generate a basic file structure. You can pass <code>app</code> or <code>lib</code> for the type, and you can optionally have a different directory name than the project name.</p>
<p>For now, let's go ahead and do <code>crystal init app mybot</code>. The generated structure looks like this:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">├── </span><span style="color:#0086b3;">LICENSE</span><span style="color:#323232;">
├── </span><span style="color:#0086b3;">README</span><span style="color:#323232;">.md
├── shard.yml
├── spec
│   ├── mybot_spec.cr
│   └── spec_helper.cr
└── src
    ├── mybot
    │   └── version.cr
    └── mybot.cr
</span><span style="color:#0086b3;">3</span><span style="color:#323232;"> directories, </span><span style="color:#0086b3;">7</span><span style="color:#323232;"> files
</span></pre>
<p><code>LICENSE</code> (MIT by default) and <code>README.md</code> are self explanatory. <code>spec</code> stores our tests, which can be run with <code>crystal spec</code>.</p>
<p><code>shard.yml</code> is the YAML configuration file for shards. Running this will generate a <code>shards.lock</code> with a snapshot of the dependencies.</p>
<p><code>src</code> is where our code lives. By default, <code>mybot.cr</code> will include files in <code>src/mybot</code>, and <code>version.cr</code> is used to track our project using <a href="https://semver.org/">Semantic Versioning</a>, starting at <code>0.1.0</code>.</p>
<h2 id="creating-your-bot">Creating your bot</h2>
<p>In order to run <code>Discord::Client</code>, we need a bot token from <a href="https://discordapp.com/developers/applications/me">Discord's apps section</a>. You'll need to create a Bot if you haven't already. <strong>Note:</strong> Make sure to click &quot;Create a Bot User&quot;, as there's a difference. Next, click &quot;show token&quot; and make sure to save that value for a moment. Copy the Client ID as well.</p>
<p>Now that the bot has been made, we have to add it to our server.
On your bot's application page, click <code>Generate OAuth2 url</code>. This will open a dialogue showing all of Discord's options for a server.</p>
<p>For now, our bot only requires <code>Send Messages</code> and <code>Read Message History</code>, <em>but</em> I imagine you'll want it to things later down the line such as editing channels, removing content, etc. You can request those things here, or do it manually on your Discord server by giving the bot a moderator <code>role</code>, etc.</p>
<h2 id="reading-and-writing-json">Reading and Writing JSON</h2>
<p>Let's create a <code>config.cr</code> file to manage our configuration file.</p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;"># src/mybot/config.cr

</span><span style="font-weight:bold;color:#a71d5d;">module </span><span style="color:#323232;">MyBot
  </span><span style="font-weight:bold;color:#a71d5d;">class </span><span style="color:#323232;">Config
    </span><span style="color:#0086b3;">JSON</span><span style="color:#323232;">.mapping(
      </span><span style="color:#0086b3;">token: String</span><span style="color:#323232;">,
      </span><span style="color:#0086b3;">client_id: UInt64
    </span><span style="color:#323232;">)
  </span><span style="font-weight:bold;color:#a71d5d;">end
end
</span></pre>
<p>Let's break that down. First, we create a <code>Config</code> class, and then <a href="https://crystal-lang.org/api/0.23.1/JSON.html#mapping-macro">JSON.mapping</a> handily lets us describe how our class gets mapped to and from JSON. We must define the type, and token is a <code>String</code>. <code>client_id</code> is an unsigned 64bit integer.</p>
<p>So now we need to create the file! Let's put it under <code>conf/bot.json</code>.</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">{
  </span><span style="font-weight:bold;color:#183691;">&quot;token&quot;</span><span style="color:#323232;">: &quot;Bot xxxxxxxxx&quot;,
  </span><span style="font-weight:bold;color:#183691;">&quot;client_id&quot;</span><span style="color:#323232;">: </span><span style="background-color:#f5f5f5;font-weight:bold;color:#b52a1d;">yyyyyyyyyyyy</span><span style="color:#323232;">
}
</span></pre>
<p>Note: We have to prefix our token with &quot;Bot &quot;.</p>
<p>Now we don't want to share that token with the world… Make sure to modify your <code>.gitignore</code> file:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">λ echo </span><span style="color:#183691;">&quot;/conf&quot; </span><span style="font-weight:bold;color:#a71d5d;">&gt;&gt;</span><span style="color:#323232;"> .gitignore
</span></pre>
<p>Almost there. Now in <code>src/mybot.cr</code>, we can load up our dependencies and config file.</p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;"># src/mybot.cr
</span><span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&quot;json&quot;
</span><span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&quot;./mybot/*&quot; </span><span style="font-style:italic;color:#969896;"># Crystal supports wildcard matching

</span><span style="font-weight:bold;color:#a71d5d;">module </span><span style="color:#323232;">MyBot
  file </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">File</span><span style="color:#323232;">.read(</span><span style="color:#0086b3;">File</span><span style="color:#323232;">.join(</span><span style="color:#183691;">&quot;conf&quot;</span><span style="color:#323232;">, </span><span style="color:#183691;">&quot;bot.json&quot;</span><span style="color:#323232;">))
  config </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">Config</span><span style="color:#323232;">.from_json(file) 
  puts config.token
</span><span style="font-weight:bold;color:#a71d5d;">end
</span></pre>
<p>First, we need to load <code>json</code> from the standard library, and our new config file. <code>File.join</code> lets us join files and directories in a system-agnostic manner (&quot;\&quot; versus &quot;/&quot;). Once we read the file, we can use <code>Config.from_json</code>, which is provided automatically when we use <code>JSON.mapping</code>.</p>
<p>If everything was done correctly, the output of <code>crystal run src/mybot.cr</code> should be your token!</p>
<h2 id="starting-up-discord-client">Starting up Discord::Client</h2>
<p>The <a href="https://github.com/meew0/discordcr/">discordcr</a> library wraps Discord's API for us and provides basic functionality. To install it, add this to your <code>shard.yml</code> file under <code>dependencies</code>:</p>
<pre style="background-color:#ffffff;">
<span style="color:#63a35c;">dependencies</span><span style="color:#323232;">:
  </span><span style="color:#63a35c;">discordcr</span><span style="color:#323232;">:
    </span><span style="color:#63a35c;">github</span><span style="color:#323232;">: </span><span style="color:#183691;">meew0/discordcr
</span></pre>
<p>Then run <code>shards install</code>. This will grab the library for us and create a <code>shard.lock</code> file.</p>
<p>Now we can edit <code>src/mybot.cr</code> again:</p>
<pre style="background-color:#ffffff;">
<span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&quot;json&quot;
</span><span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&quot;discordcr&quot;
</span><span style="font-weight:bold;color:#a71d5d;">require </span><span style="color:#183691;">&quot;./mybot/config&quot;

</span><span style="font-weight:bold;color:#a71d5d;">module </span><span style="color:#323232;">MyBot
  file </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">File</span><span style="color:#323232;">.read(</span><span style="color:#0086b3;">File</span><span style="color:#323232;">.join(</span><span style="color:#183691;">&quot;conf&quot;</span><span style="color:#323232;">, </span><span style="color:#183691;">&quot;bot.json&quot;</span><span style="color:#323232;">))
  config </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">Config</span><span style="color:#323232;">.from_json(file) 

  client </span><span style="font-weight:bold;color:#a71d5d;">= </span><span style="color:#0086b3;">Discord</span><span style="color:#323232;">::</span><span style="color:#0086b3;">Client</span><span style="color:#323232;">.</span><span style="font-weight:bold;color:#a71d5d;">new</span><span style="color:#323232;">(
    </span><span style="color:#0086b3;">token:</span><span style="color:#323232;"> config.token,
    </span><span style="color:#0086b3;">client_id:</span><span style="color:#323232;"> config.client_id
  )
</span><span style="font-weight:bold;color:#a71d5d;">end
</span></pre>
<p>If everything was done correctly, <code>crystal run src/mybot.cr</code> should produce nothing.</p>
<h2 id="listening-to-input">Listening to input</h2>
<p><code>Discord::Client</code> comes with <a href="https://meew0.github.io/discordcr/doc/master/Discord/Client.html">many instance methods</a>. We're going to be using <code>#on_message_create</code> which gives us a payload of type <a href="https://meew0.github.io/discordcr/doc/master/Discord/Message.html">Discord::Message</a>. </p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;"># src/mybot.cr
# ...
</span><span style="color:#323232;">client.on_message_create </span><span style="font-weight:bold;color:#a71d5d;">do </span><span style="color:#323232;">|payload|
  </span><span style="font-weight:bold;color:#a71d5d;">if</span><span style="color:#323232;"> payload.content.starts_with? </span><span style="color:#183691;">&quot;!ping&quot;</span><span style="color:#323232;">
    client.create_message(payload.channel_id, </span><span style="color:#183691;">&quot;Pong!&quot;</span><span style="color:#323232;">)
  </span><span style="font-weight:bold;color:#a71d5d;">end
end</span><span style="color:#323232;">

client.run
</span></pre>
<p><code>#on_message_create</code> takes a block which lets us do what we want. If the payload starts with <code>!ping</code>, we create a message in the same channel as the payload with the text <code>Pong!</code>.</p>
<p><code>client.run</code>, well, runs the bot. This will block so anything after this point will not run. We'll explore asynchronous execution through fibers later.</p>
<p>Let's check to see if our bot works.</p>
<p><a href="https:&#x2f;&#x2f;i.imgur.com&#x2f;zbR6HrC.png" data-lity data-lity-desc="Ping Test in Discord" alt="Ping Test in Discord">
<img class="full" async-src="https:&#x2f;&#x2f;i.imgur.com&#x2f;zbR6HrC.png"/>
</a></p>
<p>Hooray! Next time, we'll begin to explore a better system for commands. In the meantime, check out <a href="https://meew0.github.io/discordcr/doc/master/Discord/Client.html">Discord::Client's documentation</a> and explore to see what you can do!</p>

      <div id="email-me">
        Have any observations, criticisms, or corrections? Feel free to <a href="mailto:blog@andrewzah.com">email me</a>. Have a nice day!
      </div>
      
      
      
    </article>
  </div>
</main>
    </div>

    <div class="after-content">
      <div class="container">
        <div>
  <div id="after-main" class="container">
    <div id="random-quote">
      <h2> Random quote </h2>
      <blockquote id="random-quote-quote"></blockquote>
      <p id="random-quote-citation">
        <span id="random-quote-author"></span>
        <span id="random-quote-source"></span>
      </p>
    </div>
    <hr>

    <div class="container after-post">
        
          <div id="previous_post">
            Previous: <i>
              <a class="prev" href="/posts/books-for-2018">Books for 2018</a>
            </i>
          </div>
        

        
          <div id="next_post">
            Next: <i>
              <a class="next" href="/posts/selfhosting-git-with-gitea-docker-caddy">Selfhosting git with Gitea, Docker, Caddy</a>
            </i>
          </div>
        

        
          
  
  <div class="tags">
    Tags: 
    
      
        <a href="/tags/discord/">Discord</a> | 
      
    
      
        <a href="/tags/crystal/">Crystal</a>
      
    
  </div>

  
  <div class="categories">
    Categories: 
    
      
        <a href="/categories/programming/">Programming</a>
      
    
  </div>


        
    </div>

    <hr>
    </div>

    <footer class="footer">
    <small>
        &copy; Copyright Andrew Zah <time datetime="2019">2019</time>.
        | <a href="/contact">Contact</a>
        | <a href="https://git.sr.ht/~andrewzah/personal-site/tree">Site Source Code (AGPLv3)</a>
    </small>
</footer>

    </div>
      </div>
    </div>
  </body>
</html>
