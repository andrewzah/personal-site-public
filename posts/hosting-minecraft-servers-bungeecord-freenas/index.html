<!doctype html>
<html lang="en-us">
  <head>
      <title>Hosting Minecraft Servers + BungeeCord with FreeNAS | AZ</title>

      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Learn how to set up multiple minecraft servers in FreeNAS with a bungeecord&#x2F;waterfall proxy.">
      <meta name="author" content="Andrew Zah">
      <meta name="keywords" content="minecraft java edition papermc paper spigot bukkit freenas freebsd plugin mysql">

      <meta property="og:title" content="Hosting Minecraft Servers + BungeeCord with FreeNAS | AZ" />
      <meta property="og:author" content="Andrew Zah" />
      <meta property="og:description" content="Learn how to set up multiple minecraft servers in FreeNAS with a bungeecord&#x2F;waterfall proxy." />
      <meta property="article:author" content="Andrew Zah" />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="andrewzah.com&#x2F;posts&#x2F;hosting-minecraft-servers-bungeecord-freenas&#x2F;" />
      <meta property="og:image" content="https://andrewzah.com/og.jpg" />

      <meta name="twitter:card" content="summary">
      <meta name="twitter:site" content="@andrew_zah">
      <meta name="twitter:creator" content="@andrew_zah">
      <meta name="twitter:image" content="https://andrewzah.com/twitter-image.png">

      <link rel="stylesheet" href="/main.css">

      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=vMdnJYpmNaa">
      <link rel="manifest" href="/site.webmanifest?v=vMdnJYpmNaa">
      <link rel="mask-icon" href="/safari-pinned-tab.svg?v=vMdnJYpmNaa" color="#018a70">
      <link rel="shortcut icon" href="/favicon.ico?v=vMdnJYpmNaa">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="theme-color" content="#ffffff">

      <script async src="/js/bundle.js"></script>
      
  

    </head>

  <body>
    <div class="container content">
      
        
  <nav>
    <div id="nav-links">
      
      <ul>
        <li><a href="/">Home</a></li>
        <li class="active"><a href="/posts/">Posts</a></li>
        <li ><a href="/contact/">Links</a></li>
        <li ><a href="/contact/">About</a></li>
      </ul>
    </div>
  </nav>

      

      <main>
  <div itemtype="http://schema.org/Article" class="container post">
    <h1 class="page-title" itemprop="name">Hosting Minecraft Servers + BungeeCord with FreeNAS</h1>
    <div class="page-meta-data">
      <time itemprop="datePublished" content="2019-12-22" datetime="2019-12-22" class="page-date">
          Dec 22, 2019
          
      </time>
      <span id="word-count">
        â€”  1846 words
      </span>
    </div>
    <hr>
    
      
    
    
      <aside id="toc">
          <h2>Table of Contents</h2>
          <ol>
              <li>
                  <a href="#prerequisites">Prerequisites</a>
                  
              </li><li>
                  <a href="#preparing-the-jails">Preparing the Jails</a>
                  
              </li><li>
                  <a href="#setting-up-minecraft">Setting up Minecraft</a>
                  
              </li><li>
                  <a href="#setting-up-waterfall-bungeecord">Setting up Waterfall/Bungeecord</a>
                  
              </li><li>
                  <a href="#databases-for-plugins">Databases for Plugins</a>
                  
              </li>
          </ol>
      </aside>
    
    <article itemprop="articleBody">
      <p>Learn how to set up multiple minecraft servers in FreeNAS with a bungeecord/waterfall proxy.</p>
<p>This guide assumes you're running a FreeNAS server on a local network. If not, you'll have to update your ip address and default gateway settings accordingly.</p>
<p><a href="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;freenas_minecraft_guide&#x2F;dynmap.png" data-lity data-lity-desc="Dynmap rendering of our FreeNAS minecaft server" alt="Dynmap rendering of our FreeNAS minecaft server">
<img class="full" async-src="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;freenas_minecraft_guide&#x2F;dynmap.png"/>
</a></p>
<p class="image-desc"> Dynmap rendering of our FreeNAS minecaft server </p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Console access to a server running FreeNAS</li>
</ul>
<p>(Don't download these yet, read on)</p>
<ul>
<li>Your server jarfile: <a href="https://www.spigotmc.org/wiki/bungeecord/">spigot.jar</a>, or <a href="https://papermc.io/downloads#Paper-1.15">paper.jar</a>, etc.</li>
<li>Your proxy jarfile: <a href="https://www.spigotmc.org/wiki/bungeecord/">bungeecord.jar</a>, or <a href="https://papermc.io/downloads#Waterfall">waterfall.jar</a>, etc.</li>
</ul>
<p>This guide will be using <code>Paper</code> and <code>Waterfall</code> as they are more
performant versions of spigot and bungeecord, respectively. They also fully support spigot/bungee plugins.</p>
<h2 id="preparing-the-jails">Preparing the Jails</h2>
<p>The first thing we'll need to do is create the main jail (the one running bungeecord or waterfall).
Alter the version for the current one your server is running.</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">echo &#39;{&quot;pkgs&quot;:[&quot;openjdk12&quot;, &quot;curl&quot;]}&#39; &gt; /tmp/minecraft.json
</span></pre>
<p>When a jail is created, <code>pkg</code> isn't installed by default. Using this saves us some commands in the next step.</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">iocage create \
  --name </span><span style="font-weight:bold;color:#a71d5d;">&lt;</span><span style="color:#323232;">name</span><span style="font-weight:bold;color:#a71d5d;">&gt; </span><span style="color:#323232;">\
  --pkglist /tmp/minecraft.json
  --release 11.2-RELEASE \
  ip4_addr=</span><span style="color:#183691;">&quot;vnet0|192.168.1.xxx/24&quot; </span><span style="color:#323232;">\
  defaultrouter=</span><span style="color:#183691;">&quot;192.168.1.1&quot; </span><span style="color:#323232;">\
  vnet=</span><span style="color:#183691;">&quot;on&quot; </span><span style="color:#323232;">\
  allow_raw_sockets=</span><span style="color:#183691;">&quot;1&quot; </span><span style="color:#323232;">\
  boot=</span><span style="color:#183691;">&quot;on&quot; 
</span></pre>
<p><code>ip4_addr</code> and <code>defaultrouter</code> configure the network for our jail. If you're running the server on your local network, then it's likely the address of your router. (Typically x.x.x.1 or x.x.x.255, consult your router's manual). <code>ip4_addr</code> is the address you want to assign to the jail.</p>
<p>For <code>name</code>: If you're just creating a single server, the name <code>minecraft</code> would suffice, but I recommend a structure like:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">mc_main
mc_survival
mc_creative
...etc
</span></pre>
<p>Next, let's create directories in the jails and mount them in the root system:</p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;"># Creates the directories in the root system
</span><span style="color:#323232;">mkdir -p /xxx/data/minecraft/mc_main
mkdir -p /xxx/data/minecraft/waterfall

</span><span style="font-style:italic;color:#969896;"># Creates the directories in the jail
</span><span style="color:#323232;">iocage exec mc_main mkdir /root/minecraft
iocage exec mc_main mkdir /root/waterfall

</span><span style="font-style:italic;color:#969896;"># Mounts the directories in the root system
</span><span style="color:#323232;">iocage fstab -a mc_main \
  /xxx/data/minecraft/mc_main /root/minecraft nullfs rw 0 0
iocage fstab -a mc_main \
  /xxx/data/minecraft/waterfall /root/waterfall nullfs rw 0 0
</span></pre>
<p>Change <code>/xxx/data/</code> to a relevant filepath for your setup. My main ZFS pool is named <code>lily</code>, so I put my minecraft folders under <code>/mnt/lily/data/</code>.</p>
<h2 id="setting-up-minecraft">Setting up Minecraft</h2>
<p>We can access our jails with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">iocage console mc_main
</span></pre>
<p>Now we can cd to the minecraft directory and download our server jarfile:</p>
<pre style="background-color:#ffffff;">
<span style="color:#62a35c;">cd</span><span style="color:#323232;"> /root/minecraft

</span><span style="font-style:italic;color:#969896;"># paper
</span><span style="color:#323232;">curl -L </span><span style="color:#183691;">&#39;https://papermc.io/api/v1/paper/1.15.1/27/download&#39;</span><span style="color:#323232;"> -o paper-1.15.1_27.jar
</span></pre>
<p>Run your server jarfile with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">java -jar /root/minecraft/paper-1.15.1_27.jar
</span></pre>
<p>The process should end shortly, printing text about a <code>eula.txt</code>. Edit the file with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">sed -i .bak </span><span style="color:#183691;">&#39;s/eula=false/eula=true/g&#39;</span><span style="color:#323232;"> /root/minecraft/eula.txt
</span></pre>
<p>We also need to edit the <code>server.properties</code> file. Open it and change the server port to <code>25566</code>. We're changing this value because our proxy server (bungeecord/waterfall) will listen to the default port later.</p>
<p>Now we can run the server!</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">java -Xms1024M -Xmx1024M -jar /root/minecraft/</span><span style="font-weight:bold;color:#a71d5d;">&lt;</span><span style="color:#323232;">name</span><span style="font-weight:bold;color:#a71d5d;">&gt;</span><span style="color:#323232;">.jar
</span></pre>
<p>Observe the text output for any errors, and then go ahead and connect to it! (Go to the <code>Multiplayer</code> tab, click <code>Add Server</code>, and type in the ip address of your server, e.g. <code>192.168.1.xx:25566</code>) Once you join, text should get printed to the screen.</p>
<p>However, we have an issue. The server is currently running in an interactive session (i.e. we ran it manually). We need it to run by itself, in a noninteractive session. Some guides will recommend using <code>screen</code> or <code>tmux</code>, but I strongly recommend not using them. If your server ever restarts, you will have to go in manually and restart screen/tmux, and then your minecraft server.</p>
<p>It's far better to let <a href="https://www.freebsd.org/cgi/man.cgi?query=rc.d&amp;sektion=8&amp;n=1">rc.d</a> manage it for us. Add this script to <code>/usr/local/etc/minecraftd</code>:</p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;">#!/bin/sh
#
# PROVIDE: minecraftd
# REQUIRE: LOGIN DAEMON NETWORKING mountcritlocal
# KEYWORD: shutdown
#
# Use the following variables to configure the minecraft server. For example, to
# configure the ON/OFF knob variable:
# sysrc minecraftd_enable=&quot;YES&quot;
#
# minecraftd_enable=&quot;YES&quot;
# minecraftd_user_dir=&quot;/root/minecraft&quot;
# minecraftd_jar_path=&quot;/root/minecraft/server.jar&quot;
# minecraftd_java_opts=&quot;-Xms1024M -Xmx1024M&quot;

</span><span style="color:#62a35c;">.</span><span style="color:#323232;"> /etc/rc.subr

name</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">minecraftd
</span><span style="color:#323232;">rcvar</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">`set_rcvar`
pidfile</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">/var/run/minecraftd.pid

</span><span style="color:#323232;">load_rc_config $name

start_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_start&quot;
</span><span style="color:#323232;">stop_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_stop&quot;
</span><span style="color:#323232;">status_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_status&quot;

</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${minecraftd_enable</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;NO&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${minecraftd_user_dir</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;/root/minecraft&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${minecraftd_jar_path</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;/root/minecraft/server.jar&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${minecraftd_java_opts</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;-Xms1024M -Xmx1024M&quot;</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">minecraftd_start</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> already running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Starting $</span><span style="color:#323232;">name</span><span style="color:#183691;">...&quot;
        </span><span style="color:#323232;">/usr/sbin/daemon -f -p $pidfile \
            /usr/local/bin/java -Duser.dir=$minecraftd_user_dir \
            $minecraftd_java_opts \
            -jar $minecraftd_jar_path nogui
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> started.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">minecraftd_stop</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Stopping $</span><span style="color:#323232;">name</span><span style="color:#183691;">...&quot;
        </span><span style="color:#323232;">cat $pidfile </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">xargs kill
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Stopped.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is not running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">minecraftd_status</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is not running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

run_rc_command $1
</span></pre>
<p>We have to make the service file executable, so run:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">chmod +x /usr/local/etc/rc.d/minecraftd
</span></pre>
<p>Essentially, this script lets us not have to manage the server process manually. However we also need to update some settings:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">sysrc minecraftd_enable=</span><span style="color:#183691;">&quot;YES&quot;
</span><span style="color:#323232;">sysrc minecraftd_jar_path=</span><span style="color:#183691;">&quot;/root/minecraft/server.jar&quot;
</span><span style="color:#323232;">sysrc minecraftd_java_opts=</span><span style="color:#183691;">&quot;-Xms1G -Xmx1G&quot;
</span></pre>
<p>Make sure to change the <code>minecraftd_jar_path</code> to reflect your downloaded jarfile, and <code>minecraftd_java_opts</code> for how much memory you want to give it.</p>
<p>Now you should be able to the following:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">service minecraftd start
</span></pre>
<p>Confirm it with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">ps aux </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">grep openjdk
</span></pre>
<p>You should see something like:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">root  72816  1.2  2.5 3156872 1273052  -  IJ   Fri19   99:04.12 /usr/local/openjdk12/bin/java -Duser.dir=/root/minecraft -Xms1G -Xmx1G -jar /root/minecraft/paper-1.15.1_27.jar
</span></pre>
<p>If not, double check your settings in <code>/etc/rc.conf</code>, and make sure they point to the right files. Manually run the command to make sure it's not a minecraft configuration issue (i.e. no warnings/errors show up in the console).</p>
<p>Connect to the server again to make sure it works, then stop the server with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">service minecraftd stop
</span></pre>
<p>In order for bungee/waterfall to work, we need to edit the <code>server.properties</code> file again. Change <code>online-mode</code> to <code>false</code>.</p>
<p>In <code>spigot.yml</code>, update <code>bungeecord</code> to <code>true</code>.</p>
<p>In <code>paper.yml</code>, update <code>bungee-online-mode</code> to <code>true</code>.</p>
<p>In <code>bukkit.yml</code>, update <code>connection-throttle</code> to <code>-1</code>.</p>
<p>That's it! Now we just need to set up our proxy to get access to the server again.</p>
<h2 id="setting-up-waterfall-bungeecord">Setting up Waterfall/Bungeecord</h2>
<p>If you're not in the <code>mc_main</code> jail already, access it with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">iocage console mc_main
</span></pre>
<p>Now can cd to the waterfall directory and download <code>waterfall.jar</code>.</p>
<pre style="background-color:#ffffff;">
<span style="color:#62a35c;">cd</span><span style="color:#323232;"> /root/waterfall
</span></pre>
<p>The process for the jarfile is the same as before, except we're going to the <code>waterfall</code> directory now.</p>
<pre style="background-color:#ffffff;">
<span style="color:#62a35c;">cd</span><span style="color:#323232;"> /root/waterfall

</span><span style="font-style:italic;color:#969896;"># waterfall
</span><span style="color:#323232;">curl -L </span><span style="color:#183691;">&#39;https://papermc.io/api/v1/waterfall/1.15/309/download&#39;</span><span style="color:#323232;"> -o waterfall-1.15_309.jar
</span></pre>
<p>Run the proxy jarfile with:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">java -jar /root/waterfall/waterfall-1.15_309.jar
</span></pre>
<p>If necessary, edit <code>eula.txt</code> again:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">sed -i .bak </span><span style="color:#183691;">&#39;s/eula=false/eula=true/g&#39;</span><span style="color:#323232;"> /root/waterfall/eula.txt
</span></pre>
<p>Now we need to edit <code>config.yml</code>. Look for the <code>servers</code> section, and change it to the following:</p>
<pre style="background-color:#ffffff;">
<span style="color:#63a35c;">servers</span><span style="color:#323232;">:
  </span><span style="color:#63a35c;">hub</span><span style="color:#323232;">:
    </span><span style="color:#63a35c;">motd</span><span style="color:#323232;">: </span><span style="color:#183691;">&#39;&amp;1My amazing hub server&#39;
    </span><span style="color:#63a35c;">address</span><span style="color:#323232;">: </span><span style="color:#63a35c;">localhost:25566
    restricted</span><span style="color:#323232;">: </span><span style="color:#0086b3;">false
</span></pre>
<p>Under <code>listeners</code>, change <code>priorities</code> to:</p>
<pre style="background-color:#ffffff;">
<span style="color:#63a35c;">priorities</span><span style="color:#323232;">:
  - </span><span style="color:#183691;">hub
</span></pre>
<p>Change <code>host</code> to:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">  </span><span style="color:#63a35c;">host</span><span style="color:#323232;">: </span><span style="color:#183691;">0.0.0.0:25565
</span></pre>
<p>Finally, set <code>ip_forward: true</code>.</p>
<p>In order to run <code>waterfall</code> noninteractively, we'll use a similar <code>rc.d</code> script like before:</p>
<pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;">#!/bin/sh
#
# PROVIDE: waterfall
# REQUIRE: LOGIN DAEMON NETWORKING mountcritlocal
# KEYWORD: shutdown
#
# Use the following variables to configure the minecraft server. For example, to
# configure the ON/OFF knob variable:
# sysrc waterfall_enable=&quot;YES&quot;
#
# waterfall_enable=&quot;YES&quot;
# waterfall_user_dir=&quot;/root/waterfall&quot;
# waterfall_jar_path=&quot;/root/waterfall/waterfall.jar&quot;
# waterfall_java_opts=&quot;-Xms512M -Xmx1024M&quot;

</span><span style="color:#62a35c;">.</span><span style="color:#323232;"> /etc/rc.subr

name</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">waterfall
</span><span style="color:#323232;">rcvar</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#323232;">`set_rcvar`
pidfile</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">/var/run/waterfall.pid

</span><span style="color:#323232;">load_rc_config $name

start_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_start&quot;
</span><span style="color:#323232;">stop_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_stop&quot;
</span><span style="color:#323232;">status_cmd</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;${</span><span style="color:#323232;">name</span><span style="color:#183691;">}_status&quot;

</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${waterfall_enable</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;NO&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${waterfall_user_dir</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;/root/waterfall&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${waterfall_jar_path</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;/root/waterfall/waterfall.jar&quot;</span><span style="color:#323232;">}
</span><span style="color:#62a35c;">: </span><span style="color:#323232;">${waterfall_java_opts</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;-Xms512M -Xmx1024M&quot;</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">waterfall_start</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> already running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Starting $</span><span style="color:#323232;">name</span><span style="color:#183691;">...&quot;
        </span><span style="color:#62a35c;">cd </span><span style="color:#323232;">$waterfall_user_dir
        /usr/sbin/daemon -f -p $pidfile \
            /usr/local/bin/java -Duser.dir=$waterfall_user_dir \
            $waterfall_java_opts \
            -jar $waterfall_jar_path  nogui
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> started.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">waterfall_stop</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Stopping $</span><span style="color:#323232;">name</span><span style="color:#183691;">...&quot;
        </span><span style="color:#323232;">cat $pidfile </span><span style="font-weight:bold;color:#a71d5d;">| </span><span style="color:#323232;">xargs kill
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;Stopped.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is not running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

</span><span style="font-weight:bold;color:#795da3;">waterfall_status</span><span style="color:#323232;">() {
    </span><span style="font-weight:bold;color:#a71d5d;">if </span><span style="color:#62a35c;">[ </span><span style="color:#323232;">-e $pidfile </span><span style="color:#62a35c;">]</span><span style="font-weight:bold;color:#a71d5d;">; then
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">else
        </span><span style="color:#62a35c;">echo </span><span style="color:#183691;">&quot;$</span><span style="color:#323232;">name</span><span style="color:#183691;"> is not running.&quot;
    </span><span style="font-weight:bold;color:#a71d5d;">fi
</span><span style="color:#323232;">}

run_rc_command $1
</span></pre>
<p>We have to make the service file executable again, so run:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">chmod +x /usr/local/etc/rc.d/waterfall
</span></pre>
<p>Like before, we'll need to edit some settings:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">sysrc waterfall_enable=</span><span style="color:#183691;">&quot;YES&quot;
</span><span style="color:#323232;">sysrc waterfall_jar_path=</span><span style="color:#183691;">&quot;/root/waterfall/waterfall-1.15_309.jar&quot;
</span></pre>
<p>Now run the following and connect to your server!</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">service waterfall start
</span></pre>
<hr />
<p>Congrats, you've set up a minecraft server and a proxy server in FreeNAS!</p>
<p>For more servers, create more jails with the instructions from earlier, and follow the same server javafile setup. In <code>server.properties</code>, change <code>ip-address</code> to the address of the jail, and update waterfall's config to something like below:</p>
<pre style="background-color:#ffffff;">
<span style="color:#63a35c;">servers</span><span style="color:#323232;">:
  </span><span style="color:#63a35c;">hub</span><span style="color:#323232;">:
    </span><span style="color:#63a35c;">motd</span><span style="color:#323232;">: </span><span style="color:#183691;">&#39;My hub server&#39;
    </span><span style="color:#63a35c;">address</span><span style="color:#323232;">: </span><span style="color:#63a35c;">localhost:25566
    restricted</span><span style="color:#323232;">: </span><span style="color:#0086b3;">false
  </span><span style="color:#63a35c;">creative</span><span style="color:#323232;">:
    </span><span style="color:#63a35c;">motd</span><span style="color:#323232;">: </span><span style="color:#183691;">&#39;My creative server&#39;
    </span><span style="color:#63a35c;">address</span><span style="color:#323232;">: </span><span style="color:#63a35c;">192.168.1.21:25566
    restricted</span><span style="color:#323232;">: </span><span style="color:#0086b3;">false
  </span><span style="color:#63a35c;">survival</span><span style="color:#323232;">:
    </span><span style="color:#63a35c;">motd</span><span style="color:#323232;">: </span><span style="color:#183691;">&#39;My survival server&#39;
    </span><span style="color:#63a35c;">address</span><span style="color:#323232;">: </span><span style="color:#63a35c;">192.168.1.22:25566
    restricted</span><span style="color:#323232;">: </span><span style="color:#0086b3;">false
</span></pre><h2 id="databases-for-plugins">Databases for Plugins</h2>
<p>Many minecraft plugins can use mysql or postgres for storage. I highly recommend setting up mysql in a jail and connecting your plugins to it. Here's how you can do it:</p>
<pre style="background-color:#ffffff;">
<span style="color:#62a35c;">echo </span><span style="color:#183691;">&#39;{&quot;pkgs&quot;:[&quot;mysql80-server&quot;]}&#39; </span><span style="font-weight:bold;color:#a71d5d;">&gt;</span><span style="color:#323232;"> /tmp/mysql.json
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">iocage create \
  --name mysql \
  --pkglist /tmp/minecraft.json
  --release 11.2-RELEASE
  ip4_addr</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;vnet0|192.168.1.xxx/24&quot; </span><span style="color:#323232;">\
  defaultrouter</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;192.168.1.1&quot; </span><span style="color:#323232;">\
  vnet</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;on&quot; </span><span style="color:#323232;">\
  boot</span><span style="font-weight:bold;color:#a71d5d;">=</span><span style="color:#183691;">&quot;on&quot;
</span></pre><pre style="background-color:#ffffff;">
<span style="font-style:italic;color:#969896;"># Creates the directories in the root system
</span><span style="color:#323232;">mkdir -p /xxx/configs/mysql
mkdir -p /xxx/data/mysql

</span><span style="font-style:italic;color:#969896;"># Creates the directories in the jail
</span><span style="color:#323232;">iocage exec mysql mkdir /config
iocage exec mysql mkdir /data

</span><span style="font-style:italic;color:#969896;"># Mounts the directories in the root system
</span><span style="color:#323232;">iocage fstab -a mysql \
  /xxx/configs/mysql /config nullfs rw 0 0
iocage fstab -a mysql \
  /xxx/data/mysql /data nullfs rw 0 0
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">iocage console mysql
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">sysrc mysql_enable=</span><span style="color:#183691;">&quot;YES&quot;
</span><span style="color:#323232;">sysrc mysql_dbdir=</span><span style="color:#183691;">&quot;/data&quot;
</span><span style="color:#323232;">sysrc mysql_confdir=</span><span style="color:#183691;">&quot;/config&quot;
</span><span style="color:#323232;">sysrc mysql_optfile=</span><span style="color:#183691;">&quot;/config/my.cnf&quot;
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">cp /usr/local/etc/mysql/my.cnf /config/my.cnf
</span></pre>
<p>Now edit <code>/config/my.cnf</code> and change <code>bind-address</code> to <code>0.0.0.0</code>. This lets us connect remotely, except for <code>root</code>. We don't want to run things as root, anyway.</p>
<p>Connect to the local mysql database after creating the root user and password:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">service mysql-server start
mysql_secure_installation
mysql -uroot -p
</span></pre>
<p>Once connected, create the database and user that the plugin will be using. For example, if we were making a database for <code>coreprotect</code>:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">create database coreprotect_hub</span><span style="font-weight:bold;color:#a71d5d;">;

</span><span style="color:#323232;">CREATE USER </span><span style="color:#183691;">&#39;coreprotect&#39;</span><span style="color:#323232;">@</span><span style="color:#183691;">&#39;192.168.1.0/255.255.255.0&#39;</span><span style="color:#323232;"> IDENTIFIED WITH mysql_native_password BY </span><span style="color:#183691;">&#39;password&#39;</span><span style="font-weight:bold;color:#a71d5d;">;

</span><span style="color:#323232;">grant all privileges on coreprotect_hub.</span><span style="font-weight:bold;color:#a71d5d;">*</span><span style="color:#323232;"> to </span><span style="color:#183691;">&#39;coreprotect&#39;</span><span style="color:#323232;">@</span><span style="color:#183691;">&#39;192.168.1.0/255.255.255.0&#39;</span><span style="font-weight:bold;color:#a71d5d;">;
</span></pre>
<p>The reason we're using <code>@'192.168.1.0/255.255.255.0'</code> is to allow remote connections, but only within the local network.</p>
<p>Now update your plugin's <code>config.yml</code>, where <code>host</code> is the ip address of the mysql jail, and <code>port</code> is <code>3306</code>.</p>
<p>It's a good idea to create a separate database and user for each plugin and server. For example, I have the databases <code>coreprotect_survival</code>, and <code>coreprotect_creative</code>, both of which have different users.</p>

      <hr>
      <div id="email-me">
        Have any observations, criticisms, or corrections? Feel free to <a href="mailto:blog@andrewzah.com">email me</a>. Have a nice day!
      </div>
      
        
  <div id="resources">
    <h3> Further Reading </h3>
    <ul>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;iocage.readthedocs.io&#x2F;en&#x2F;latest&#x2F;">
              iocage - A FreeBSD Jail Manager
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;aikar.co&#x2F;2018&#x2F;07&#x2F;02&#x2F;tuning-the-jvm-g1gc-garbage-collector-flags-for-minecraft&#x2F;">
              Tuning the JVM - G1GC Garbage Collector Flags for Minecraft
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;devpro.media&#x2F;minecraft-server-freenas&#x2F;">
              Installing a Minecraft server on FreeNAS
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.computerhope.com&#x2F;jargon&#x2F;n&#x2F;netmask.htm">
              What is a Netmask?
            </a>
          </span>
        </li>
      
    </ul>
  </div>

      
      
      
    </article>
  </div>
</main>
    </div>

    <div class="after-content">
      <div class="container">
        <div>
  <div id="after-main" class="container">
    <div id="random-quote">
      <h2> Random quote </h2>
      <blockquote id="random-quote-quote"></blockquote>
      <p id="random-quote-citation">
        <span id="random-quote-author"></span>
        <span id="random-quote-source"></span>
      </p>
    </div>
    <hr>

    <div class="container after-post">
        
          <div id="previous_post">
            Previous: <i>
              <a class="prev" href="/posts/building-home-server-freenas">Building a Home Server with FreeNAS</a>
            </i>
          </div>
        

        
          <div id="next_post">
            Next: <i>
              <a class="next" href="/posts/my-850-dollar-watch-cant-render-korean-text">My $850 watch can&#x27;t render Korean text</a>
            </i>
          </div>
        

        
          
  
  <div class="tags">
    Tags: 
    
      
        <a href="/tags/minecraft/">Minecraft</a> | 
      
    
      
        <a href="/tags/freebsd/">Freebsd</a>
      
    
  </div>

  
  <div class="categories">
    Categories: 
    
      
        <a href="/categories/selfhosting/">Selfhosting</a>
      
    
  </div>


        
    </div>

    <hr>

    <div>
      <form id="mailing-list"
        action="https://tinyletter.com/andrewzah"
        method="post" target="popupwindow"
        onsubmit="window.open('https://tinyletter.com/andrewzah', 'popupwindow', 'scrollbars=yes,width=800');return true">
        <label for="tlemail">
          Enjoy posts like this? Sign up for the mailing list!
        </label>
        <div>
          <input type="text" class="form-label" name="email" id="tlemail" />
          <input type="hidden" value="1" name="embed"/>
          <input type="submit" class="button button-primary" style="" value="Subscribe" />
        </div>
        Note: I hate spam mail as much as you do.
      </form>
    </div>
    <hr>
    </div>

    <footer class="footer">
    <small>
        &copy; Copyright Andrew Zah <time datetime="2019">2019</time>
        | <a href="/contact">Contact</a>
        | <a href="https://git.sr.ht/~andrewzah/personal-site/tree">Site Source Code (AGPLv3)</a>
    </small>
</footer>

    </div>
      </div>
    </div>

    <!-- Matomo -->
    <script type="text/javascript">
      var _paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//matomo.andrewzah.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '2']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code -->

  </body>
</html>
