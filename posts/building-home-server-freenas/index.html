<!doctype html>
<html lang="en-us">
  <head>
      <title>Building a Home Server with FreeNAS | AZ</title>

      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="I built a home server with FreeNAS and an amd ryzen.">
      <meta name="author" content="Andrew Zah">
      <meta name="keywords" content="home server setup amd ryzen ixsystems freebsd freenas">

      <meta property="og:title" content="Building a Home Server with FreeNAS | AZ" />
      <meta property="og:author" content="Andrew Zah" />
      <meta property="og:description" content="I built a home server with FreeNAS and an amd ryzen." />
      <meta property="article:author" content="Andrew Zah" />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="andrewzah.com&#x2F;posts&#x2F;building-home-server-freenas&#x2F;" />
      <meta property="og:image" content="https://andrewzah.com/og.jpg" />

      <meta name="twitter:card" content="summary">
      <meta name="twitter:site" content="@andrew_zah">
      <meta name="twitter:creator" content="@andrew_zah">
      <meta name="twitter:image" content="https://andrewzah.com/twitter-image.png">

      <link rel="stylesheet" href="/main.css">

      <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=vMdnJYpmNaa">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=vMdnJYpmNaa">
      <link rel="manifest" href="/site.webmanifest?v=vMdnJYpmNaa">
      <link rel="mask-icon" href="/safari-pinned-tab.svg?v=vMdnJYpmNaa" color="#018a70">
      <link rel="shortcut icon" href="/favicon.ico?v=vMdnJYpmNaa">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="theme-color" content="#ffffff">

      <script async src="/js/bundle.js"></script>
      
  

    </head>

  <body>
    <div class="container content">
      
        
  <nav>
    <div id="nav-links">
      
      <ul>
        <li><a href="/">Home</a></li>
        <li class="active"><a href="/posts/">Posts</a></li>
        <li ><a href="/contact/">Links</a></li>
        <li ><a href="/contact/">About</a></li>
      </ul>
    </div>
  </nav>

      

      <main>
  <div itemtype="http://schema.org/Article" class="container post">
    <h1 class="page-title" itemprop="name">Building a Home Server with FreeNAS</h1>
    <div class="page-meta-data">
      <time itemprop="datePublished" content="2019-12-21" datetime="2019-12-21" class="page-date">
          Dec 21, 2019
          
      </time>
      <span id="word-count">
        â€”  1479 words
      </span>
    </div>
    <hr>
    
      
    
    
      <aside id="toc">
          <h2>Table of Contents</h2>
          <ol>
              <li>
                  <a href="#my-goals">My Goals</a>
                  
              </li><li>
                  <a href="#the-requirements">The Requirements</a>
                  
              </li><li>
                  <a href="#part-list">Part List</a>
                  
              </li><li>
                  <a href="#usage">Usage</a>
                  
              </li><li>
                  <a href="#a-use-for-the-raspberry-pi">A Use for the Raspberry Pi</a>
                  <ol>
                      <li>
                          <a href="#why-freenas">Why FreeNAS?</a>
                      </li>
                  </ol>
              </li>
          </ol>
      </aside>
    
    <article itemprop="articleBody">
      <p>A few months ago I got gripped with server fever. I'd had a raspberry pi for a while, but I could never find a meaningful use for it. I'd tried running plex, etc, but the pi3 would choke after a bit and sputter out.</p>
<p>One day I decided enough was enough: it was time to build a more beefy server. (and I found a compelling use for the pi!)</p>
<p><a href="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;freenas-info.png" data-lity data-lity-desc="FreeNAS server information" alt="FreeNAS server information">
<img class="full" async-src="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;freenas-info.png"/>
</a></p>
<p class="image-desc"> Current FreeNAS server information </p>
<h3 id="my-goals">My Goals</h3>
<p>I had a few goals I wanted to achieve:</p>
<ol>
<li>be relatively future-proof</li>
<li>host a plex server</li>
<li>be able to spin up multiple VMs for various reasons like testing ansible scripts</li>
<li>potentially host games for me and my brother</li>
</ol>
<p>If all you want to do is host Plex/jellyfish, a raspberry pi should suffice. As long as your media isn't hvec x265. Before I built this server I had two 2tb drives plugged into my raspberry pi, and other content was fine for the most part.</p>
<h3 id="the-requirements">The Requirements</h3>
<p>I don't have space in my home for a rack for a server, due to both the size and noise. That immediately eliminated a lot of build paths that I saw.</p>
<p>The ideal spot for the server was my living room, so I needed a relatively low profile server- and a <em>quiet</em> one.</p>
<p>The remaining requirements were:</p>
<ul>
<li>at least 8 hard drive bays</li>
<li>a relatively modern/beefy cpu</li>
<li>low(er) power consumption</li>
</ul>
<p>I felt like 8 drives (+1 or 2 ssds) was enough for future expansion, even with RAID-10 taken into account.
I went with a mirrored structure so I could replace drives without heavy rebuild times, and so I could easily expand the pool if necessary.
I started with 6 drives, so I have a zpool with 3 vdevs of 2 drives each.</p>
<h3 id="part-list">Part List</h3>
<p>What I thought was going to be a relatively simple task turned into a huge amount of research...
I spent most of my time on <a href="https://www.ixsystems.com/community/">iXsystems' community forum</a>
and <a href="https://www.reddit.com/r/homelab/">/r/homelab</a> on reddit. The people on iXsystems' forum were very helpful and detailed. However, most of the information for iXsystems is based around used intel boards. Much less material is available if you're like me and are interested in newer AMD cpus.</p>
<p>So how did I narrow it down? I did what I always do: make a spreadsheet. There are simply way too many options presented to figure what cpu/mobo to choose without spreadsheet analysis. Without further ado:</p>
<ul>
<li>case: <a href="https://docs.google.com/spreadsheets/d/1pThQQLHIcB_LO6-PmypGOSeaErY_ip6FY2lmbkS0DYc/Fractal%20Design%20Node%20804%20Black%20Window%20Aluminum/Steel%20MATX">Fractal Node 804 Micro Atx Case</a></li>
<li>boot ssd (nvme): <a href="https://www.newegg.com/western-digital-black-nvme-250gb/p/N82E16820250097">WD Black NVMe M.2 2280 250Gb PCI-Express 3.0 x4 SSD WDS250G2X0C</a></li>
<li>ssd: <a href="https://www.newegg.com/apc-bx1500m-5-x-nema-5-15r-5-x-nema-5-15r/p/N82E16842301561?Description=APC%20BX1500M%20Back-UPS%20Pro%201500VA%2f900W&amp;cm_re=APC_BX1500M_Back-UPS_Pro_1500VA%2f900W-_-42-301-561-_-Product">SAMSUNG 860 EVO Series 2.5&quot; 500GB MZ-76E500B/AM</a></li>
<li>intake fans x4: <a href="https://smile.amazon.com/dp/B00650P2ZC/?tag=ozlp-20">Noctua NF-F12 WPM 120mm</a></li>
<li>exhaust fans x2: <a href="https://smile.amazon.com/dp/B00CP6QLY6/?tag=ozlp-20">Noctua NF-A14 PWM 140mm</a></li>
<li>cpu cooler: <a href="https://smile.amazon.com/Noctua-NH-L12S-Low-Profile-Cooler-Quiet/dp/B075SF5QQ8/ref=sr_1_2?keywords=NH-L12S&amp;qid=1565553407&amp;s=gateway&amp;sr=8-2">Noctua NH-L12S 70mm Low-Profile CPU Cooler</a></li>
<li>ups/apc: <a href="andrewzah.com/posts/building-home-server-freenas/">https://www.newegg.com/apc-bx1500m-5-x-nema-5-15r-5-x-nema-5-15r/p/N82E16842301561?Description=APC%20BX1500M%20Back-UPS%20Pro%201500VA%2f900W&amp;cm_re=APC_BX1500M_Back-UPS_Pro_1500VA%2f900W-<em>-42-301-561-</em>-Product</a></li>
<li>psu: <a href="https://www.newegg.com/seasonic-focus-plus-650-gold-ssr-650fx-650w/p/N82E16817151186">Seasonic FOCUS Plus Series SSR-650FX 650W</a></li>
</ul>
<p>The total comes out to around $632. I don't know why anyone would build a server without getting some sort of UPS/APC as well.</p>
<hr />
<ul>
<li>cpu: <a href="https://www.newegg.com/amd-ryzen-5-3600/p/N82E16819113569?Description=5%203600%20amd&amp;cm_re=5_3600_amd-_-19-113-569-_-Product">AMD Ryzen 5 3600 - 3.6Ghz/4.2Ghz 6-core</a></li>
<li>mobo: <a href="https://www.newegg.com/p/N82E16813157887?Description=asrock%20x570m%20&amp;cm_re=asrock_x570m-_-13-157-887-_-Product">ASRock X570M Pro4 AM4 MicroAtx</a></li>
<li>ram x3: <a href="https://smile.amazon.com/Crucial-DDR4-21300-Server-Memory-CT16G4WFD8266/dp/B078N7HC6L">Crucial 16GB DDR4-2666 ECC UDIMM CT16G4WFD8266</a></li>
</ul>
<p>The total was $676 for these parts, with $291 for the memory alone. DDR4 ram with ecc isn't cheap. For comparison, a Xeon E5-2650 V2 goes for around $70 on ebay, with significantly cheaper DDR3 ram.</p>
<div class="note note-Note">
  <h4>Note</h4>
  <span>I&#x27;ve used the ryzen setup for 3+ months now with no issues.</span>
</div>
<hr />
<p>So I was already at $1,300, <em>before</em> purchasing hard drives. I bought 6 Western Digital Red 4TB drives initially, @ $100. Later on I got 2 more drives, and another stick of ram.</p>
<p>Altogether, it was $1300 for the parts + $800 for the drives, or ~$2100 in total.</p>
<p>I didn't go with a used intel board because of the higher power usage and less powerful specs. This made my build much more expensive, but also more future proof.</p>
<h3 id="usage">Usage</h3>
<p>I adapted my jail setup and structure from <a href="https://gist.github.com/mow4cash/e2fd4991bd2b787ca407a355d134b0ff">this gist</a>, and installed rancheros via <a href="https://github.com/redshift-s/rancheros-docker-media">this guide</a>.</p>
<p>I currently have 20 <a href="https://en.wikipedia.org/wiki/FreeBSD_jail">jails</a> running, and 5 docker containers running in <a href="https://rancher.com/rancher-os/">RancherOS</a> (which <a href="https://www.ixsystems.com/documentation/freenas/11.2-U7/virtualmachines.html">runs in a VM</a> with 2 cpus and 4GB memory).</p>
<p>Why jails over docker? Convenience, I guess. It's far easier for me to muck around in iocage jails than it is to inspect and debug docker containers. Unfortunately this does mean if I lose my server, I'd have to recreate all those jails... but setting them up in the first place was pretty easy once I learned how <a href="https://www.freebsd.org/cgi/man.cgi?query=rc.d&amp;sektion=8&amp;n=1">rc.d</a> worked.</p>
<p>Services that I run:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">backblaze
  -&gt; data backup
bazarr
  -&gt; grabs subtitles in multiple languages, hooks into radarr/sonarr
caddy
  -&gt; reverse proxy to some of these services
calendar
  -&gt; radicale
kitana
  -&gt; ui for plex plugins
mailbackup
  -&gt; offlineimap + cron
node_exporter
  -&gt; feeds into prometheus on the raspberry pi
paperless
  -&gt; digital document store
plex
  -&gt; media catalogue + streaming
radarr
  -&gt; monitors local shows for for bazarr subtitle grabbing
sonarr
  -&gt; monitors local movies for for bazarr subtitle grabbing
syncthing
  -&gt; seamlessly sync files between computers
thelounge
  -&gt; modern irc client. I used to use znc+weechat, but I got
     tired of weechat&#39;s ux. thelounge is simple and pretty.
</span></pre><pre style="background-color:#ffffff;">
<span style="color:#323232;">postgres
mysql
</span></pre>
<p>Several services use databases, so I elected to set aside jails for them.</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">mc_main
mc_creative
mc_survival
</span></pre>
<p>I also run 3 instances of minecraft via <a href="https://papermc.io/">PaperMC</a>, a high performance fork of <a href="https://www.spigotmc.org/">Spigot</a>. The main jail runs <a href="https://github.com/PaperMC/Waterfall">Waterfall</a>
(a fork of <a href="https://github.com/SpigotMC/BungeeCord">bungeecord</a>) along with a hub instance.
Waterfall acts as a proxy and lets one access multiple servers within a network.</p>
<p>My docker services:</p>
<pre style="background-color:#ffffff;">
<span style="color:#323232;">andrewzah/gollum
  -&gt; a wiki with changes automatically git pushed
  -&gt; a fork of gollum with user logins
insekticid/docker-piwiki (matomo)
  -&gt; self-hosted analytics (tracking andrewzah.com)
  -&gt; respects requests to not track user
radhifadlillah/shiori
  -&gt; self-hosted website backup, similar to archive.web
huginn/huginn
  -&gt; self-hosted, more powerful version of IFTTT
cwspear/docker-local-persist-volume-plugin
  -&gt; allows local volume mounts in portainer/rancheros
portainer/portainer
</span></pre>
<p><a href="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;freenas-memory.png" data-lity data-lity-desc="FreeNAS memory graph" alt="FreeNAS memory graph">
<img class="full" async-src="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;freenas-memory.png"/>
</a></p>
<p class="image-desc"> Current FreeNAS memory graph </p>
<h3 id="a-use-for-the-raspberry-pi">A Use for the Raspberry Pi</h3>
<p>Once I built the server, I had no use for my raspberry pi3 and 4. Until I learned about <a href="https://prometheus.io/">prometheus</a> and <a href="https://grafana.com/">grafana</a>.</p>
<p>Having metrics and a dashboard is awesome, but if my server crashes, I no longer have access to the metrics... So they have to be run somewhere else! This is where the raspberry pi comes in- it just sits on my local network ingesting traffic.</p>
<p>Unfortunately, node_exporter doesn't seem to export hdd temperature values, which is pretty important. I'll probably have to write a simple script to pull those values and host another metrics target for prometheus.</p>
<p><a href="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;grafana-node-exporter.png" data-lity data-lity-desc="Grafana with node_exporter metrics from FreeNAS" alt="Grafana with node_exporter metrics from FreeNAS">
<img class="full" async-src="https:&#x2F;&#x2F;s3.amazonaws.com&#x2F;andrewzah.com&#x2F;posts&#x2F;serverbuild-freenas&#x2F;grafana-node-exporter.png"/>
</a></p>
<p class="image-desc"> Grafana with node_exporter metrics from FreeNAS </p>
<h4 id="why-freenas">Why FreeNAS?</h4>
<p>FreeNAS has extensive documentation. and *BSDs are nice. ZFS and RAID are nice. Free Software is nice. </p>
<p>If I didn't use docker so heavily I would likely use FreeBSD or OpenBSD for my personal computers as well instead of Debian.</p>
<hr />
<p>Overall the process of building a server was pretty fun, but I'm glad I'm done with that for the foreseeable future. I didn't self-host that much when I began, but once I started adding services I started thinking about everything I could self host.</p>

      <hr>
      <div id="email-me">
        Have any observations, criticisms, or corrections? Feel free to <a href="mailto:blog@andrewzah.com">email me</a>. Have a nice day!
      </div>
      
        
  <div id="resources">
    <h3> Further Reading </h3>
    <ul>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;documentation&#x2F;freenas&#x2F;11.2-U7-legacy&#x2F;freenas.html">
              FreeNASÂ® 11.2-U7 User Guide
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;community&#x2F;resources&#x2F;links-to-useful-threads.108&#x2F;">
              iXsystems: Links to useful threads
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;community&#x2F;resources&#x2F;specific-build-components-list-up-to-32gb-ram.109&#x2F;">
              iXsystems: Specific build components list - up to 32GB RAM
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;community&#x2F;threads&#x2F;slideshow-explaining-vdev-zpool-zil-and-l2arc-for-noobs.7775&#x2F;">
              iXsystems: Slideshow explaining VDev, zpool, ZIL and L2ARC for noobs!
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;community&#x2F;threads&#x2F;amd-ryzen-build.74232&#x2F;">
              AMD Ryzen Build
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.ixsystems.com&#x2F;blog&#x2F;zfs-dictionary&#x2F;">
              iXsystems: ZFS dictionary
            </a>
          </span>
        </li>
      
        <li>
          <span>
            <a href="https:&#x2F;&#x2F;www.freebsd.org&#x2F;doc&#x2F;en_US.ISO8859-1&#x2F;articles&#x2F;rc-scripting&#x2F;index.html">
              Practical rc.d scripting in BSD
            </a>
          </span>
        </li>
      
    </ul>
  </div>

      
      
      
    </article>
  </div>
</main>
    </div>

    <div class="after-content">
      <div class="container">
        <div>
  <div id="after-main" class="container">
    <div id="random-quote">
      <h2> Random quote </h2>
      <blockquote id="random-quote-quote"></blockquote>
      <p id="random-quote-citation">
        <span id="random-quote-author"></span>
        <span id="random-quote-source"></span>
      </p>
    </div>
    <hr>

    <div class="container after-post">
        
          <div id="previous_post">
            Previous: <i>
              <a class="prev" href="/posts/my-setup-remote-programming-osx-2019">My setup for remote programming on OSX in 2019</a>
            </i>
          </div>
        

        
          <div id="next_post">
            Next: <i>
              <a class="next" href="/posts/hosting-minecraft-servers-bungeecord-freenas">Hosting Minecraft Servers + BungeeCord with FreeNAS</a>
            </i>
          </div>
        

        
          
  
  <div class="tags">
    Tags: 
    
      
        <a href="/tags/servers/">Servers</a> | 
      
    
      
        <a href="/tags/workflow/">Workflow</a>
      
    
  </div>

  
  <div class="categories">
    Categories: 
    
      
        <a href="/categories/selfhosting/">Selfhosting</a>
      
    
  </div>


        
    </div>

    <hr>

    <div>
      <form id="mailing-list"
        action="https://tinyletter.com/andrewzah"
        method="post" target="popupwindow"
        onsubmit="window.open('https://tinyletter.com/andrewzah', 'popupwindow', 'scrollbars=yes,width=800');return true">
        <label for="tlemail">
          Enjoy posts like this? Sign up for the mailing list!
        </label>
        <div>
          <input type="text" class="form-label" name="email" id="tlemail" />
          <input type="hidden" value="1" name="embed"/>
          <input type="submit" class="button button-primary" style="" value="Subscribe" />
        </div>
        Note: I hate spam mail as much as you do.
      </form>
    </div>
    <hr>
    </div>

    <footer class="footer">
    <small>
        &copy; Copyright Andrew Zah <time datetime="2019">2019</time>
        | <a href="/contact">Contact</a>
        | <a href="https://git.sr.ht/~andrewzah/personal-site/tree">Site Source Code (AGPLv3)</a>
    </small>
</footer>

    </div>
      </div>
    </div>

    <!-- Matomo -->
    <script type="text/javascript">
      var _paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//matomo.andrewzah.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '2']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code -->

  </body>
</html>
